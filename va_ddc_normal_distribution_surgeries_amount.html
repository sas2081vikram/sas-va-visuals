<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Normal Distribution - Surgeries Amount</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
  <!-- ✅ Correct SAS helper scripts -->
  <script src="https://sassoftware.github.io/sas-visualanalytics-thirdpartyvisualizations/util/messagingUtil.js"></script>
  <script src="https://sassoftware.github.io/sas-visualanalytics-thirdpartyvisualizations/util/contentUtil.js"></script>
</head>
<body>
  <h2 style="font-family:Arial; text-align:center;">
    Normal Distribution of Surgeries Amount
  </h2>
  <div id="chart" style="width:100%;height:600px;"></div>

  <script>
    // ✅ Function to draw chart
    function drawNormalDistribution(values) {
      if (!values || values.length === 0) {
        document.getElementById("chart").innerHTML = "<b>No data available</b>";
        return;
      }

      // Parse to numbers
      values = values.map(v => Number(v)).filter(v => !isNaN(v));

      // Histogram
      var traceHist = {
        x: values,
        type: "histogram",
        histnorm: "probability density",
        name: "Data",
        opacity: 0.6
      };

      // Fit normal curve
      var mean = math.mean(values);
      var sd = math.std(values);

      var x_vals = math.range(mean - 4 * sd, mean + 4 * sd, sd / 50).toArray();
      var y_vals = x_vals.map(x => (1 / (sd * Math.sqrt(2 * Math.PI))) *
                                   Math.exp(-0.5 * Math.pow((x - mean) / sd, 2)));

      var traceCurve = {
        x: x_vals,
        y: y_vals,
        type: "scatter",
        mode: "lines",
        name: "Normal Curve"
      };

      var layout = {
        title: "Normal Distribution (Mean=" + mean.toFixed(2) +
               ", SD=" + sd.toFixed(2) + ")",
        barmode: "overlay",
        xaxis: { title: "Amount" },
        yaxis: { title: "Density" }
      };

      Plotly.newPlot("chart", [traceHist, traceCurve], layout);
    }

    // ✅ Callback when SAS VA sends data
    function onDataReceived(messageFromVA) {
      console.log("✅ Data received from VA:", messageFromVA);

      try {
        // Flatten values (assuming 1 numeric measure assigned)
        var values = messageFromVA.data.map(row => row[0]);
        drawNormalDistribution(values);
      } catch (err) {
        console.error("Error processing VA data:", err);
        document.getElementById("chart").innerHTML =
          "<b>Error: Could not process data</b>";
      }
    }

    // ✅ Register callback with SAS helper
    va.messagingUtil.setOnDataReceivedCallback(onDataReceived);
  </script>
</body>
</html>
