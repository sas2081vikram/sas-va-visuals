<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Normal Distribution for Surgery Amounts</title>

  <!-- Plotly for charting -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <!-- Math.js for stats -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>

  <!-- SAS VA helper scripts (official source) -->
  <script src="https://sassoftware.github.io/sas-visualanalytics-thirdpartyvisualizations/util/messagingUtil.js"></script>
  <script src="https://sassoftware.github.io/sas-visualanalytics-thirdpartyvisualizations/util/contentUtil.js"></script>

  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #chart { width:100%; height:100vh; }
  </style>
</head>
<body>
  <div id="chart">Waiting for SAS VA data...</div>

  <script>
    // Callback: triggered when SAS VA sends data
    function onDataReceived(messageFromVA) {
      if (!messageFromVA || !messageFromVA.data || messageFromVA.data.length === 0) {
        document.getElementById("chart").innerHTML = "⚠️ No data received from SAS VA.";
        return;
      }

      // --- DEBUG: Uncomment to see raw JSON
      // document.getElementById("chart").innerHTML =
      //   "<pre>" + JSON.stringify(messageFromVA, null, 2) + "</pre>";
      // return;

      // Extract the first numeric column only
      let colIndex = 0;
      let numericValues = messageFromVA.data
        .map(row => parseFloat(row[colIndex]))
        .filter(v => !isNaN(v));

      if (numericValues.length === 0) {
        document.getElementById("chart").innerHTML = "⚠️ No numeric values found.";
        return;
      }

      // Stats
      let mean = math.mean(numericValues);
      let std = math.std(numericValues);

      // Histogram
      let hist = {
        x: numericValues,
        type: "histogram",
        name: "Surgery Amounts",
        opacity: 0.6,
        marker: { color: "blue" }
      };

      // Normal distribution curve
      let xVals = math.range(mean - 4*std, mean + 4*std, (8*std)/100).toArray();
      let yVals = xVals.map(x =>
        (1 / (std * Math.sqrt(2 * Math.PI))) *
        Math.exp(-0.5 * Math.pow((x - mean) / std, 2))
      );

      // Scale curve to match histogram
      let scale = numericValues.length * (1 / 20); // approx bin width
      let curve = {
        x: xVals,
        y: yVals.map(v => v * scale),
        mode: "lines",
        name: "Normal Curve",
        line: { color: "red", width: 2 }
      };

      // Plot
      let layout = {
        title: "Normal Distribution of Surgery Amounts",
        barmode: "overlay",
        xaxis: { title: "Surgery Amount" },
        yaxis: { title: "Frequency" }
      };

      Plotly.newPlot("chart", [hist, curve], layout, {responsive:true});
    }

    // Register listener
    va.messagingUtil.setOnDataReceivedCallback(onDataReceived);
  </script>
</body>
</html>
