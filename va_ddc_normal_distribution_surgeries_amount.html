<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Normal Distribution for Surgeries Amount</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>

  <!-- SAS VA Utilities (same as d3_BarChart sample) -->
  <script type="text/javascript" src="../util/messagingUtil.js"></script>
  <script type="text/javascript" src="../util/contentUtil.js"></script>

  <style>
    body { margin:0; font-family: sans-serif; }
    #chart { width: 100%; height: 100vh; }
  </style>
</head>
<body>
  <div id="chart"></div>

  <script>
    // Callback when SAS VA sends data
    function onDataReceived(messageFromVA) {
      console.log("✅ Data from VA:", messageFromVA);

      if (!messageFromVA || !messageFromVA.data || !messageFromVA.data.length) {
        document.getElementById("chart").innerHTML = "⚠️ No data received from SAS VA";
        return;
      }

      // Extract the first assigned measure (e.g., Surgery Amount)
      var rawData = messageFromVA.data.map(d => {
        var vals = Object.values(d);
        return parseFloat(vals[0]);
      }).filter(v => !isNaN(v));

      if (rawData.length === 0) {
        document.getElementById("chart").innerHTML = "⚠️ No numeric values to plot";
        return;
      }

      // Histogram
      var traceHist = {
        x: rawData,
        type: 'histogram',
        histnorm: 'probability density',
        name: 'Surgeries',
        opacity: 0.6
      };

      // Fit normal curve
      var mean = math.mean(rawData);
      var std = math.std(rawData);
      var xVals = math.range(math.min(rawData), math.max(rawData), (math.max(rawData)-math.min(rawData))/100, true).toArray();
      var yVals = xVals.map(x => (1/(std * Math.sqrt(2*Math.PI))) * Math.exp(-0.5 * Math.pow((x-mean)/std, 2)));

      var traceCurve = {
        x: xVals,
        y: yVals,
        type: 'scatter',
        mode: 'lines',
        name: 'Normal Curve'
      };

      // Plot
      Plotly.newPlot('chart', [traceHist, traceCurve], {
        title: 'Normal Distribution of Surgeries Amount',
        xaxis: { title: 'Amount' },
        yaxis: { title: 'Density' }
      });
    }

    // Register the callback (SAS style)
    va.messagingUtil.setOnDataReceivedCallback(onDataReceived);
  </script>
</body>
</html>
