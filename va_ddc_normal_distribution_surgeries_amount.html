<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script src="https://unpkg.com/@sassoftware/va-report-components/dist/va-report-components.js"></script>
</head>
<body>
  <div id="chart" style="width:100%;height:100%;"></div>
  <script>
    va.contentUtil.initialize(onDataReceived);

    function onDataReceived(messageFromVA) {
      if (!messageFromVA || !messageFromVA.data || messageFromVA.data.length === 0) {
        document.getElementById("chart").innerHTML = "⚠️ No data assigned";
        return;
      }

      // Get assigned column name dynamically
      let colName = messageFromVA.columns[0].name;

      // Extract numeric values
      let numericValues = messageFromVA.data.map(row => Number(row[0])).filter(v => !isNaN(v));
      if (numericValues.length === 0) {
        document.getElementById("chart").innerHTML = "⚠️ Assigned variable has no numeric values";
        return;
      }

      // Stats
      let mean = math.mean(numericValues);
      let std = math.std(numericValues);

      // Histogram bin size
      let binSize = (math.max(numericValues) - math.min(numericValues)) / 20;

      let hist = {
        x: numericValues,
        type: "histogram",
        name: colName,
        opacity: 0.6,
        marker: { color: "blue" },
        xbins: {
          start: math.min(numericValues),
          end: math.max(numericValues),
          size: binSize
        }
      };

      // Normal curve
      let xVals = math.range(mean - 4*std, mean + 4*std, (8*std)/200).toArray();
      let yVals = xVals.map(x =>
        (1 / (std * Math.sqrt(2 * Math.PI))) *
        Math.exp(-0.5 * Math.pow((x - mean) / std, 2))
      );

      // Scale to histogram
      let maxHistHeight = numericValues.length * binSize ? numericValues.length : 1;
      let maxPdfHeight = Math.max(...yVals);
      let scale = maxHistHeight / maxPdfHeight;

      let curve = {
        x: xVals,
        y: yVals.map(v => v * scale),
        mode: "lines",
        name: "Normal Curve",
        line: { color: "red", width: 3 }
      };

      // Layout with dynamic title & axis label
      let layout = {
        title: `Normal Distribution of ${colName}`,
        barmode: "overlay",
        xaxis: { title: colName },
        yaxis: { title: "Frequency" }
      };

      Plotly.newPlot("chart", [hist, curve], layout, {responsive:true});
    }
  </script>
</body>
</html>
